name: CD - DÃ©ploiement Continu

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:  # Permet le dÃ©clenchement manuel
    inputs:
      environment:
        description: 'Environnement de dÃ©ploiement'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      version:
        description: 'Version Ã  dÃ©ployer'
        required: false
        default: 'latest'

env:
  PYTHON_VERSION: "3.10"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: PrÃ©paration du dÃ©ploiement
  prepare-deployment:
    name: ğŸš€ PrÃ©paration DÃ©ploiement
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      version: ${{ steps.determine-version.outputs.version }}
      should-deploy: ${{ steps.determine-env.outputs.should-deploy }}
    
    steps:
    - name: ğŸ¯ DÃ©termination de l'environnement
      id: determine-env
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=staging" >> $GITHUB_OUTPUT
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" =~ ^refs/tags/v.* ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        else
          echo "should-deploy=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“‹ DÃ©termination de la version
      id: determine-version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" =~ ^refs/tags/.* ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "version=latest-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        fi

  # Job 2: Tests de prÃ©-dÃ©ploiement
  pre-deployment-tests:
    name: ğŸ§ª Tests PrÃ©-dÃ©ploiement
    runs-on: ubuntu-latest
    needs: prepare-deployment
    if: needs.prepare-deployment.outputs.should-deploy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: ğŸ§ª Tests complets
      run: |
        python -m pytest tests/ \
          --cov=src \
          --cov-fail-under=80 \
          -v \
          --tb=short

    - name: ğŸ”’ VÃ©rifications de sÃ©curitÃ©
      run: |
        bandit -r src/ -ll
        safety check

    - name: ğŸ“¦ Test de build
      run: |
        python -m build
        twine check dist/*

  # Job 3: Build et publication Docker (si applicable)
  build-and-push-docker:
    name: ğŸ³ Build Docker
    runs-on: ubuntu-latest
    needs: [prepare-deployment, pre-deployment-tests]
    if: needs.prepare-deployment.outputs.should-deploy == 'true'
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ” Login au Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha

    - name: ğŸ”¨ Build et Push de l'image Docker
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

  # Job 4: DÃ©ploiement Staging
  deploy-staging:
    name: ğŸŒ± DÃ©ploiement Staging
    runs-on: ubuntu-latest
    needs: [prepare-deployment, pre-deployment-tests]
    if: |
      needs.prepare-deployment.outputs.should-deploy == 'true' && 
      needs.prepare-deployment.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.votre-app.com
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸš€ DÃ©ploiement vers Staging
      run: |
        echo "ğŸŒ± DÃ©ploiement vers l'environnement staging..."
        echo "Version: ${{ needs.prepare-deployment.outputs.version }}"
        
        # Exemple de dÃ©ploiement (Ã  adapter selon votre infrastructure)
        # ./scripts/deploy.sh staging ${{ needs.prepare-deployment.outputs.version }}
        
        # Ou dÃ©ploiement via SSH
        # ssh user@staging-server "cd /app && ./deploy.sh ${{ needs.prepare-deployment.outputs.version }}"
        
        # Ou dÃ©ploiement Kubernetes
        # kubectl set image deployment/app app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare-deployment.outputs.version }}

    - name: ğŸ§ª Tests post-dÃ©ploiement Staging
      run: |
        echo "ğŸ§ª Tests post-dÃ©ploiement staging..."
        # Tests de santÃ© de l'application
        # curl -f https://staging.votre-app.com/health
        # python tests/e2e/test_staging.py

    - name: ğŸ“¢ Notification Slack Staging
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        text: |
          ğŸŒ± DÃ©ploiement Staging: ${{ job.status }}
          Version: ${{ needs.prepare-deployment.outputs.version }}
          Commit: ${{ github.sha }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Job 5: DÃ©ploiement Production (aprÃ¨s validation manuelle)
  deploy-production:
    name: ğŸ­ DÃ©ploiement Production
    runs-on: ubuntu-latest
    needs: [prepare-deployment, pre-deployment-tests, deploy-staging]
    if: |
      needs.prepare-deployment.outputs.should-deploy == 'true' && 
      needs.prepare-deployment.outputs.environment == 'production'
    environment:
      name: production
      url: https://votre-app.com
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ›¡ï¸ VÃ©rifications prÃ©-production
      run: |
        echo "ğŸ›¡ï¸ VÃ©rifications supplÃ©mentaires pour la production..."
        # VÃ©rifications spÃ©cifiques Ã  la production
        # - Base de donnÃ©es prÃªte
        # - Services externes disponibles
        # - Monitoring en place

    - name: ğŸš€ DÃ©ploiement vers Production
      run: |
        echo "ğŸ­ DÃ©ploiement vers la production..."
        echo "Version: ${{ needs.prepare-deployment.outputs.version }}"
        
        # DÃ©ploiement production avec stratÃ©gie blue-green ou canary
        # ./scripts/deploy.sh production ${{ needs.prepare-deployment.outputs.version }}

    - name: ğŸ§ª Tests post-dÃ©ploiement Production
      run: |
        echo "ğŸ§ª Tests post-dÃ©ploiement production..."
        sleep 30  # Attente stabilisation
        # Tests critiques de santÃ©
        # curl -f https://votre-app.com/health
        # python tests/e2e/test_production.py

    - name: ğŸ“Š Monitoring post-dÃ©ploiement
      run: |
        echo "ğŸ“Š Activation du monitoring renforcÃ©..."
        # Activation d'alertes spÃ©cifiques post-dÃ©ploiement
        # VÃ©rification des mÃ©triques clÃ©s

    - name: ğŸ“¢ Notification Ã©quipe Production
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#production'
        text: |
          ğŸ­ DÃ©ploiement Production: ${{ job.status }}
          Version: ${{ needs.prepare-deployment.outputs.version }}
          Commit: ${{ github.sha }}
          URL: https://votre-app.com
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Job 6: Publication sur PyPI (pour les packages)
  publish-pypi:
    name: ğŸ“¦ Publication PyPI
    runs-on: ubuntu-latest
    needs: [prepare-deployment, pre-deployment-tests]
    if: |
      startsWith(github.ref, 'refs/tags/v') && 
      needs.prepare-deployment.outputs.should-deploy == 'true'
    environment:
      name: pypi
      url: https://pypi.org/project/votre-package
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Installation des outils de build
      run: |
        python -m pip install --upgrade pip build twine

    - name: ğŸ”¨ Construction du package
      run: |
        python -m build

    - name: ğŸ” VÃ©rification du package
      run: |
        twine check dist/*

    - name: ğŸ“¤ Publication sur PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        verbose: true

    - name: ğŸ“‹ CrÃ©ation GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
        body: |
          ## ğŸš€ Release ${{ github.ref }}
          
          ### âœ¨ NouveautÃ©s
          - Voir CHANGELOG.md pour les dÃ©tails
          
          ### ğŸ“¦ Installation
          ```bash
          pip install votre-package==${{ github.ref }}
          ```
          
          ### ğŸ”— Liens utiles
          - [Documentation](https://votre-package.readthedocs.io)
          - [PyPI](https://pypi.org/project/votre-package)

  # Job 7: Rollback automatique en cas d'Ã©chec
  rollback-on-failure:
    name: ğŸ”„ Rollback Automatique
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: |
      always() && 
      (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ”„ Rollback vers version prÃ©cÃ©dente
      run: |
        echo "ğŸ”„ Rollback automatique en cours..."
        # Commandes de rollback spÃ©cifiques Ã  votre infrastructure
        # ./scripts/rollback.sh

    - name: ğŸš¨ Notification d'urgence
      uses: 8398a7/action-slack@v3
      with:
        status: 'failure'
        channel: '#alerts'
        text: |
          ğŸš¨ ROLLBACK AUTOMATIQUE DÃ‰CLENCHÃ‰ ğŸš¨
          Raison: Ã‰chec du dÃ©ploiement
          Commit: ${{ github.sha }}
          Action requise: VÃ©rification manuelle
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}